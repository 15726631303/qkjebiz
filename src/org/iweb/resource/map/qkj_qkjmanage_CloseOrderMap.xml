<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"  "sql-map-2.dtd">
<sqlMap>
	<!-- CloseOrder Start -->
	<typeAlias alias="closeOrder" type="com.qkj.manage.domain.CloseOrder" />
	<select id="qkjmanage_getCloseOrders" resultClass="closeOrder" parameterClass="java.util.Map">
		<![CDATA[ 
			SELECT c.*,m.`MEMBER_NAME` member_name,au.`USER_NAME` add_user_name,lu.`LM_USER` lm_user_name FROM qkjm_r_closeorder c
LEFT JOIN s_vip_member m ON (c.`member_id`=m.`UUID`)
LEFT JOIN s_sys_user au ON(c.`add_user`=au.`UUID`)
LEFT JOIN s_sys_user lu ON(c.`lm_user`=lu.`UUID`)
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="uuid"><![CDATA[ c.uuid=#uuid# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="close_time"><![CDATA[ c.close_time=#close_time# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="content"><![CDATA[ c.content=#content# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="member_id"><![CDATA[ c.member_id=#member_id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="member_address"><![CDATA[ c.member_address=#member_address# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="check_user"><![CDATA[ c.check_user=#check_user# ]]></isNotEmpty>

		</dynamic>
		<![CDATA[ LIMIT 1000 ]]>
	</select>
	<select id="qkjmanage_getCloseOrdersCounts" resultClass="int" parameterClass="java.util.Map">
		<![CDATA[ 
			Select Count(*) From qkjm_r_closeorder
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="uuid"><![CDATA[ uuid=#uuid# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="close_time"><![CDATA[ close_time=#close_time# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="content"><![CDATA[ content=#content# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="member_id"><![CDATA[ member_id=#member_id# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="member_address"><![CDATA[ member_address=#member_address# ]]></isNotEmpty>
			<isNotEmpty prepend="AND" property="check_user"><![CDATA[ check_user=#check_user# ]]></isNotEmpty>

		</dynamic>
		<![CDATA[ LIMIT 1000 ]]>
	</select>
	<insert id="qkjmanage_addCloseOrder" parameterClass="closeOrder">
		<![CDATA[ 
			Insert Into qkjm_r_closeorder(close_time,content,theme,member_id,member_address,member_phone,add_user,add_time,lm_time,lm_user,salPro_id)
			Values (#close_time#,#content#,#theme#,#member_id#,#member_address#,#member_phone#,#add_user#,#add_time#,#lm_time#,#lm_user#,#salPro_id#)
		]]>
		<selectKey resultClass="int" keyProperty="uuid">
		<![CDATA[ Select LAST_INSERT_ID() ]]>
		</selectKey>
	</insert>
	<update id="qkjmanage_mdyCloseOrder" parameterClass="closeOrder">
		<![CDATA[
			Update qkjm_r_closeorder
			Set close_time=#close_time#,
			content=#content#,
			theme=#theme#,
			member_id=#member_id#,
			member_address=#member_address#,
			member_phone=#member_phone#,
			lm_time=#lm_time#,
			lm_user=#lm_user#,
			salPro_id=#salPro_id#
			Where uuid = #uuid#
		]]>
	</update>
	
	<update id="qkjmanage_mdyCloseCheck" parameterClass="closeOrder">
		<![CDATA[
			Update qkjm_r_closeorder
			Set 
			check_state=#check_state#,
			check_time=#check_time#,
			check_user=#check_user#,
			lm_time=#lm_time#,
			lm_user=#lm_user#
			Where uuid = #uuid#
		]]>
	</update>
	
	<update id="qkjmanage_mdyClosendCheck" parameterClass="closeOrder">
		<![CDATA[
			Update qkjm_r_closeorder
			Set 
			nd_check_state=#nd_check_state#,
			nd_check_time=#nd_check_time#,
			nd_check_user=#nd_check_user#,
			lm_time=#lm_time#,
			lm_user=#lm_user#
			Where uuid = #uuid#
		]]>
	</update>
	
	
	<update id="qkjmanage_mdyCloseOrdertotelPrice" parameterClass="integer">
		<![CDATA[
		UPDATE qkjm_r_closeorder c SET c.totel_price=(
			SELECT IFNULL(SUM(a.total_price),0) FROM (SELECT p.`total_price` FROM qkjm_r_closeorder_product p WHERE p.order_id=#value#)a
		)WHERE c.uuid=#value#
		]]>
	</update>
	<delete id="qkjmanage_delCloseOrder" parameterClass="closeOrder">
	<![CDATA[
		Delete From qkjm_r_closeorder Where uuid=#uuid#
	]]>
	</delete>
	<!-- CloseOrder End -->
</sqlMap>